<!DOCTYPE html>
<html class="dark">
  
<!-- Mirrored from Kodeville.io/lessons/how-to-rate-limit-writes-firestore/ by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 09 Jan 2024 17:06:21 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Firestore Rate Limiting</title>
    <link rel="shortcut icon" href="../../img/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="../../svelte/index.be288b01.css" />
    <script type="module" defer src="../../svelte/index.3d7fd5b5.js" /></script>

    
    <link rel="shortcut icon" href="../../img/favicon.png" type="image/x-icon">
    <link rel="apple-touch-icon" type="image/x-icon" href="../../img/favicon.png" />
    <meta name="theme-color" content="#454e56">
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <link rel="manifest" href="../../manifest.json">
    

 




    <link rel="canonical" href="index.html" />

    <meta name="description" content="Advanced security rules and techniques for rate-limiting Firestore writes.">
    <meta name="image" content="https://Kodeville.io/lessons/how-to-rate-limit-writes-firestore/img/featured.png">

    <meta property="og:title" content="Firestore Rate Limiting" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://Kodeville.io/lessons/how-to-rate-limit-writes-firestore/" />
    <meta property="og:image" content="https://Kodeville.io/lessons/how-to-rate-limit-writes-firestore/img/featured.png" />
    <meta property="og:description" content="Advanced security rules and techniques for rate-limiting Firestore writes." />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@Kodeville_dev">
    <meta name="twitter:title" content="Firestore Rate Limiting">
    <meta name="twitter:description" content="Advanced security rules and techniques for rate-limiting Firestore writes.">
    <meta name="twitter:image" content="https://Kodeville.io/lessons/how-to-rate-limit-writes-firestore/img/featured.png">
    
    <script>
      if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
              navigator.serviceWorker.register('../../sw.js');
          });
      }
    </script>

  </head>
  <body>
    <global-data 
    permalink="https://Kodeville.io/lessons/how-to-rate-limit-writes-firestore/" 
    vimeo="376656177"
    youtube=""
    free=""
    next="https://Kodeville.io/lessons/firestore-pagination-guide/" 
    prev="https://Kodeville.io/lessons/flutter-ipod/">
  </global-data>

    
<nav class="flex justify-between container p-6 md:p-8">
  <a
    class="flex justify-center items-center text-center w-12 h-12 logo-gif"
    href="../../index.html"
  >
    <img id="logo" src="../../img/logo.svg" alt="logo" />
    <img class="relative bottom-1 left-1" id="logoBg" src="../../img/fire.gif" alt="fire background" />
  </a>

  <ul class="flex justify-center items-center">
    <if-pro>
      <li slot="basic" class="mx-2 md:mx-4  hover:scale-105 transition-transform">
        <a href="../../pro/index.html" class="font-display text-base font-normal text-green-500 border-green-400 border rounded-md px-2 py-1 hover:drop-shadow-[0_0_9px_rgba(34,197,94,0.9)]">PRO</a>
      </li>
    </if-pro>
    <li class="mx-2 md:mx-4 hover:scale-105 transition-transform">
      <a href="../index.html" class="font-sans text-xl font-bold leading-none text-gray2 hover:text-white">labs</a>
    </li>
    <li class="mx-2 md:mx-4  hover:scale-105 transition-transform">
      <a href="../../courses/index.html" class="font-sans text-xl font-bold leading-none text-gray2 gradient-slide">courses</a>
    </li>
    <li class="ml-2">
      <modal-action type="open" name="search">
        <button class="p-2 mr-2 hidden md:flex justify-between items-center bg-white bg-opacity-10 hover:bg-opacity-20 border border-gray4 hover:border-purple-500 
                 shadow-xl hover:drop-shadow-[0_0_7px_rgba(168,85,247,0.5)] transition-all">
          <span class="text-gray2 w-4 mx-2">
<svg aria-hidden="true" focusable="false" data-prefix="fad" data-icon="search" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-inline--fa fk-search fk-w-16 fk-9x">
<g class="fk-group"><path fill="currentColor" d="M208 80a128 128 0 1 1-90.51 37.49A127.15 127.15 0 0 1 208 80m0-80C93.12 0 0 93.12 0 208s93.12 208 208 208 208-93.12 208-208S322.88 0 208 0z" class="fk-secondary"></path><path fill="currentColor" d="M504.9 476.7L476.6 505a23.9 23.9 0 0 1-33.9 0L343 405.3a24 24 0 0 1-7-17V372l36-36h16.3a24 24 0 0 1 17 7l99.7 99.7a24.11 24.11 0 0 1-.1 34z" class="fk-primary">
</path></g></svg></span>
          <span class="mr-12">Search</span>
          <span class="mx-2 text-xs border border-gray4 rounded-md p-1 px-2">/</span>
        </button>
        <button class="flex md:hidden">
          <span class="text-gray2 w-6 mx-2">
<svg aria-hidden="true" focusable="false" data-prefix="fad" data-icon="search" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-inline--fa fk-search fk-w-16 fk-9x">
<g class="fk-group"><path fill="currentColor" d="M208 80a128 128 0 1 1-90.51 37.49A127.15 127.15 0 0 1 208 80m0-80C93.12 0 0 93.12 0 208s93.12 208 208 208 208-93.12 208-208S322.88 0 208 0z" class="fk-secondary"></path><path fill="currentColor" d="M504.9 476.7L476.6 505a23.9 23.9 0 0 1-33.9 0L343 405.3a24 24 0 0 1-7-17V372l36-36h16.3a24 24 0 0 1 17 7l99.7 99.7a24.11 24.11 0 0 1-.1 34z" class="fk-primary">
</path></g></svg></span>
        </button>
        </modal-action>
      </li>
    <li class="ml-2 mr-6 relative">
      <if-user>
        <a href="../../dashboard/index.html">
          <user-avatar></user-avatar>
        </a>
        <modal-action slot="signed-out" name="signin" type="open">
          <button class="relative hidden md:inline-block px-4 py-2 text-xl font-display text-black hover:text-white bg-white 
                hover:bg-purple-600 drop-shadow-[6px_6px_0_black] hover:drop-shadow-[0_0_7px_rgba(168,85,247,0.5)] transition-all duration-300">
            login
          </button>
          <button class="flex md:hidden">
            <span class="text-gray2 w-6 mx-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M352 96h64c17.7 0 32 14.3 32 32V384c0 17.7-14.3 32-32 32H352c-17.7 0-32 14.3-32 32s14.3 32 32 32h64c53 0 96-43 96-96V128c0-53-43-96-96-96H352c-17.7 0-32 14.3-32 32s14.3 32 32 32zm-7.5 177.4c4.8-4.5 7.5-10.8 7.5-17.4s-2.7-12.9-7.5-17.4l-144-136c-7-6.6-17.2-8.4-26-4.6s-14.5 12.5-14.5 22v72H32c-17.7 0-32 14.3-32 32v64c0 17.7 14.3 32 32 32H160v72c0 9.6 5.7 18.2 14.5 22s19 2 26-4.6l144-136z"/></svg>
</span>
          </button>
        </modal-action>
      </if-user>
    </li>


  </ul>
</nav>


    
<main class="container">


	<div class="flex w-full justify-between">


		<article itemscope itemtype="http://schema.org/Article" class="w-full">
			<meta itemprop="datePublished" content="2019-11-30 08:11:12 -0700 -0700" />
			<meta itemprop="dateModified" content="2019-11-30 08:11:12 -0700 -0700" />
			<meta itemprop="image" content="img/featured.png" />
			<meta itemprop="publisher" content="Kodeville.io" />


			<header>

				
				

				
					<video-player single="true"></video-player>
				

				<div class="bg-gray6 py-5 px-3 rounded-lg mb-4 flex justify-between mt-3">

					
					
					<a class="flex items-center no-underline" itemprop="author" name="Jeff Delaney" href="../../contributors/jeff-delaney/index.html">
						<img class="w-10 h-10 rounded-full block" src="../../contributors/img/jeff-delaney.webp" alt="Jeff Delaney avatar">
						<span class="flex flex-col ml-2">
							<span class="no-underline">By Jeff Delaney</span>
							<span class="text-xs text-gray4">Posted <time itemprop="dateModified">Nov 30, 2019</time>
						</span>
	
					</a>

					
					<span>
						
							<a href="../../tags/firebase/index.html"><span class="tag tag-firebase">#firebase</span></a>
						
							<a href="../../tags/firestore/index.html"><span class="tag tag-firestore">#firestore</span></a>
						
							<a href="../../tags/security/index.html"><span class="tag tag-security">#security</span></a>
						
							<a href="../../tags/pro/index.html"><span class="tag tag-pro">#pro</span></a>
						

						
					</span>
					
				
				</div>

			</header>



			
			<section class="prose dark:prose-invert max-w-full lesson-content" itemprop="articleBody">
				


				<h1 itemprop="name headline" id="firestore-rate-limiting" class="gradient-text">
					Firestore Rate Limiting
				</h1>


				<p><a href="https://github.com/firebase/firebase-js-sdk/issues/647">Rate limiting</a> is the process of blocking access to cloud resources after a certain threshold has been reached. Firestore bills based on the quantity of reads and writes, but does not currently provide a way to block IPs or set explicit rate limits with <a href="../../snippets/firestore-rules-recipes/index.html">Security Rules</a>. So how do you prevent a <a href="https://www.cloudflare.com/learning/ddos/what-is-a-ddos-attack/">DDoS</a> attack or a disgruntled user from spamming the app with unnecessary records.</p>
<p>The following examples are based on an app that needs to&hellip;</p>
<ul>
<li>Limit users to 5 document create actions per account (absolute threshold).</li>
<li>Limit users to 1 new document per minute (time-based).</li>
</ul>
<p>Firestore rules can achieve these security requirements by combining a batch write with <a href="https://firebase.google.com/docs/reference/rules/rules.firestore.html#.getAfter">getAfter</a> - a new feature available in Firestore security rules. The following examples use this technique to ensure a user cannot manipulate a count beyond a certain threshold or time constraint.</p>
<p>Never use a rule like <code>allow write: true</code> in your database in production. Write operations should always include some form of authentication.</p>
<h2 id="rate-limit-by-quantity">Rate Limit by Quantity</h2>
<h3 id="scenario">Scenario</h3>
<p>A user is limited to 5 projects per account. Imagine a SaaS project-management app that expects to increase limits through paid accounts.</p>
<h3 id="data-model">Data Model</h3>
<p>This implementation requires two documents. . First, you need a document that stores the current project count that is connected to the current user, like <code>users/{uid}</code>. Second, you have the main UI data located in a subcollection like <code>users/{uid}/projects/{id}</code></p>
<p>The user document keeps a registry of the projects as a <a href="https://firebase.google.com/docs/reference/rules/rules.Map">Map</a> of timestamps. This makes it possible to validate that multiple documents are part of the same batch write.</p>
<p><strong>users/{userId}</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">projects: { 
</span></span><span class="line"><span class="cl">    projectA: Timestamp
</span></span><span class="line"><span class="cl">    projectB: Timestamp
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><figure><img src="img/rate-limit-user.png"/>
</figure>

<p><strong>users/{userId}/projects/{projectId}</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">createdAt: Timestamp;
</span></span></code></pre></div><figure><img src="img/rate-limit-project.png"/>
</figure>

<p>In order to perform a valid write, the user request a batch that updates the user document while creating a new project document. Notice how they share a timestamp.</p>


<div class="file-name">
  <span class="file-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><title>file_type_js</title><path d="M18.774,19.7a3.727,3.727,0,0,0,3.376,2.078c1.418,0,2.324-.709,2.324-1.688,0-1.173-.931-1.589-2.491-2.272l-.856-.367c-2.469-1.052-4.11-2.37-4.11-5.156,0-2.567,1.956-4.52,5.012-4.52A5.058,5.058,0,0,1,26.9,10.52l-2.665,1.711a2.327,2.327,0,0,0-2.2-1.467,1.489,1.489,0,0,0-1.638,1.467c0,1.027.636,1.442,2.1,2.078l.856.366c2.908,1.247,4.549,2.518,4.549,5.376,0,3.081-2.42,4.769-5.671,4.769a6.575,6.575,0,0,1-6.236-3.5ZM6.686,20c.538.954,1.027,1.76,2.2,1.76,1.124,0,1.834-.44,1.834-2.15V7.975h3.422V19.658c0,3.543-2.078,5.156-5.11,5.156A5.312,5.312,0,0,1,3.9,21.688Z" style="fill:#f5de19"/></svg>
</span> batch.js
</div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">batch</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">batch</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">timestamp</span> <span class="o">=</span> <span class="nx">firebase</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nx">serverTimestamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">userRef</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">uid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">projectRef</span> <span class="o">=</span> <span class="nx">userRef</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;projects&#39;</span><span class="p">).</span><span class="nx">doc</span><span class="p">();</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">batch</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">projectRef</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span><span class="nx">yourData</span><span class="p">,</span> <span class="nx">createdAt</span><span class="o">:</span> <span class="nx">timestamp</span><span class="p">(),</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">batch</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">userRef</span><span class="p">,</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">       <span class="nx">projects</span><span class="o">:</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">         <span class="p">[</span><span class="nx">projectRef</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="o">:</span> <span class="nx">timestamp</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">      <span class="p">},</span> <span class="p">{</span> <span class="nx">merge</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">batch</span><span class="p">.</span><span class="nx">commit</span><span class="p">()</span>
</span></span></code></pre></div><h3 id="security-rules">Security Rules</h3>
<p>The rules below validate the rate limit in three steps.</p>
<p><code>getAfter</code> is a relatively new function that gets projected contents of a document after the batch write is finished, as if the current write had succeeded.</p>
<ol>
<li>Validate ownership of the document based on the auth UID.</li>
<li>Validate the new projectId is registered on the parent user doc with a matching timestamp. Without this step, the user could potentially add new documents while bypassing the update the parent document.</li>
<li>Validate the rate limit by measuring the length of keys in the map.</li>
</ol>
<p>Note: This rule requires 0 to 2 document reads to execute.</p>


<div class="file-name">
  <span class="file-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><title>file_type_firebase</title><path d="M5.8,24.6l.17-.237L13.99,9.149l.017-.161L10.472,2.348a.656.656,0,0,0-1.227.207Z" style="fill:#ffc24a"/><path d="M5.9,24.42l.128-.25L13.965,9.114,10.439,2.448a.6.6,0,0,0-1.133.206Z" style="fill:#ffa712"/><path d="M16.584,14.01l2.632-2.7L16.583,6.289a.678.678,0,0,0-1.195,0L13.981,8.971V9.2Z" style="fill:#f4bd62"/><path d="M16.537,13.9l2.559-2.62L16.537,6.4a.589.589,0,0,0-1.074-.047L14.049,9.082l-.042.139Z" style="fill:#ffa50e"/><polygon points="5.802 24.601 5.879 24.523 6.158 24.41 16.418 14.188 16.548 13.834 13.989 8.956 5.802 24.601" style="fill:#f6820c"/><path d="M16.912,29.756,26.2,24.577,23.546,8.246A.635.635,0,0,0,22.471,7.9L5.8,24.6l9.233,5.155a1.927,1.927,0,0,0,1.878,0" style="fill:#fde068"/><path d="M26.115,24.534,23.483,8.326a.557.557,0,0,0-.967-.353L5.9,24.569l9.131,5.1a1.912,1.912,0,0,0,1.863,0Z" style="fill:#fcca3f"/><path d="M16.912,29.6a1.927,1.927,0,0,1-1.878,0L5.876,24.522,5.8,24.6l9.233,5.155a1.927,1.927,0,0,0,1.878,0L26.2,24.577l-.023-.14Z" style="fill:#eeab37"/></svg>
</span> firestore.rules
</div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">match</span> <span class="o">/</span><span class="nx">users</span><span class="o">/</span><span class="p">{</span><span class="nx">uid</span><span class="p">}</span><span class="o">/</span><span class="nx">projects</span><span class="o">/</span><span class="p">{</span><span class="nx">docId</span><span class="p">}</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="nx">allow</span> <span class="nx">create</span><span class="o">:</span> <span class="k">if</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. Validate ownership
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">request</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">uid</span> <span class="o">==</span> <span class="nx">uid</span> 
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. Validate both docs have matching timestamps for the documentId
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">getAfter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="sr">/databases/</span><span class="nx">$</span><span class="p">(</span><span class="nx">database</span><span class="p">)</span><span class="o">/</span><span class="nx">documents</span><span class="o">/</span><span class="nx">users</span><span class="o">/</span><span class="nx">$</span><span class="p">(</span><span class="nx">uid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">projects</span><span class="p">[</span><span class="nx">docId</span><span class="p">]</span> <span class="o">==</span> <span class="nx">request</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">createdAt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. Validate Rate-limit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">getAfter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="sr">/databases/</span><span class="nx">$</span><span class="p">(</span><span class="nx">database</span><span class="p">)</span><span class="o">/</span><span class="nx">documents</span><span class="o">/</span><span class="nx">users</span><span class="o">/</span><span class="nx">$</span><span class="p">(</span><span class="nx">uid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">projects</span><span class="p">.</span><span class="nx">keys</span><span class="p">().</span><span class="nx">size</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">match</span> <span class="o">/</span><span class="nx">users</span><span class="o">/</span><span class="p">{</span><span class="nx">uid</span><span class="p">}</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="nx">allow</span> <span class="nx">update</span><span class="o">:</span> <span class="k">if</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 1. Validate key cannot be changed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">resource</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">projects</span><span class="p">.</span><span class="nx">keys</span><span class="p">().</span><span class="nx">hasAny</span><span class="p">(</span> <span class="nx">request</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">projects</span><span class="p">.</span><span class="nx">keys</span><span class="p">()</span> <span class="p">)</span> <span class="o">==</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span></code></pre></div><h2 id="rate-limit-by-time">Rate Limit By Time</h2>
<h3 id="scenario-1">Scenario</h3>
<p>Imagine we have a commenting system. The user should be limited to creating one comment per minute.</p>
<h3 id="data-model-1">Data Model</h3>
<p><strong>users/{userId}</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">lastComment: Timestamp;
</span></span></code></pre></div><figure><img src="img/time-limit-user.png"/>
</figure>

<p><strong>posts/{postId}/comments/{commentId}</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">createdAt: Timestamp;
</span></span></code></pre></div><figure><img src="img/rate-limit-post.png"/>
</figure>



<div class="file-name">
  <span class="file-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><title>file_type_js</title><path d="M18.774,19.7a3.727,3.727,0,0,0,3.376,2.078c1.418,0,2.324-.709,2.324-1.688,0-1.173-.931-1.589-2.491-2.272l-.856-.367c-2.469-1.052-4.11-2.37-4.11-5.156,0-2.567,1.956-4.52,5.012-4.52A5.058,5.058,0,0,1,26.9,10.52l-2.665,1.711a2.327,2.327,0,0,0-2.2-1.467,1.489,1.489,0,0,0-1.638,1.467c0,1.027.636,1.442,2.1,2.078l.856.366c2.908,1.247,4.549,2.518,4.549,5.376,0,3.081-2.42,4.769-5.671,4.769a6.575,6.575,0,0,1-6.236-3.5ZM6.686,20c.538.954,1.027,1.76,2.2,1.76,1.124,0,1.834-.44,1.834-2.15V7.975h3.422V19.658c0,3.543-2.078,5.156-5.11,5.156A5.312,5.312,0,0,1,3.9,21.688Z" style="fill:#f5de19"/></svg>
</span> batch.js
</div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">batch</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">batch</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">timestamp</span> <span class="o">=</span> <span class="nx">firebase</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nx">serverTimestamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">userRef</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">uid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">commentRef</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">id</span><span class="p">).</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">).</span><span class="nx">doc</span><span class="p">();</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">batch</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">userRef</span><span class="p">,</span> <span class="p">{</span> <span class="nx">lastComment</span><span class="o">:</span> <span class="nx">timestamp</span><span class="p">()</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="nx">batch</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">commentRef</span><span class="p">,</span> <span class="p">{</span> <span class="nx">createdAt</span><span class="o">:</span> <span class="nx">timestamp</span><span class="p">()</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">batch</span><span class="p">.</span><span class="nx">commit</span><span class="p">();</span>
</span></span></code></pre></div><h3 id="security-rules-1">Security Rules</h3>
<p>Firestore provides a global <a href="https://firebase.google.com/docs/reference/rules/rules.duration_">duration function</a> that can calculate the distance between two timestamps. The rule below subtracts 1 minute from the request time, then compares it to the last comment timestamp. Notice how the first validation uses <code>get</code>, but the second uses <code>getAfter</code> - we need the data before the change is committed when checking duration.</p>


<div class="file-name">
  <span class="file-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><title>file_type_firebase</title><path d="M5.8,24.6l.17-.237L13.99,9.149l.017-.161L10.472,2.348a.656.656,0,0,0-1.227.207Z" style="fill:#ffc24a"/><path d="M5.9,24.42l.128-.25L13.965,9.114,10.439,2.448a.6.6,0,0,0-1.133.206Z" style="fill:#ffa712"/><path d="M16.584,14.01l2.632-2.7L16.583,6.289a.678.678,0,0,0-1.195,0L13.981,8.971V9.2Z" style="fill:#f4bd62"/><path d="M16.537,13.9l2.559-2.62L16.537,6.4a.589.589,0,0,0-1.074-.047L14.049,9.082l-.042.139Z" style="fill:#ffa50e"/><polygon points="5.802 24.601 5.879 24.523 6.158 24.41 16.418 14.188 16.548 13.834 13.989 8.956 5.802 24.601" style="fill:#f6820c"/><path d="M16.912,29.756,26.2,24.577,23.546,8.246A.635.635,0,0,0,22.471,7.9L5.8,24.6l9.233,5.155a1.927,1.927,0,0,0,1.878,0" style="fill:#fde068"/><path d="M26.115,24.534,23.483,8.326a.557.557,0,0,0-.967-.353L5.9,24.569l9.131,5.1a1.912,1.912,0,0,0,1.863,0Z" style="fill:#fcca3f"/><path d="M16.912,29.6a1.927,1.927,0,0,1-1.878,0L5.876,24.522,5.8,24.6l9.233,5.155a1.927,1.927,0,0,0,1.878,0L26.2,24.577l-.023-.14Z" style="fill:#eeab37"/></svg>
</span> firestore.rules
</div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">match</span> <span class="nx">posts</span><span class="o">/</span><span class="p">{</span><span class="nx">postId</span><span class="p">}</span><span class="o">/</span><span class="nx">comments</span><span class="o">/</span><span class="p">{</span><span class="nx">commentId</span><span class="p">}</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">allow</span> <span class="nx">create</span><span class="o">:</span> <span class="k">if</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1">// 1. Validate at least one minute has passed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">get</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="sr">/databases/</span><span class="nx">$</span><span class="p">(</span><span class="nx">database</span><span class="p">)</span><span class="o">/</span><span class="nx">documents</span><span class="o">/</span><span class="nx">users</span><span class="o">/</span><span class="nx">$</span><span class="p">(</span><span class="nx">uid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">lastComment</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">time</span> <span class="o">-</span> <span class="nx">duration</span><span class="p">.</span><span class="nx">value</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;&amp;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1">// 2. Validate matching timestamps after operation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">getAfter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="sr">/databases/</span><span class="nx">$</span><span class="p">(</span><span class="nx">database</span><span class="p">)</span><span class="o">/</span><span class="nx">documents</span><span class="o">/</span><span class="nx">users</span><span class="o">/</span><span class="nx">$</span><span class="p">(</span><span class="nx">uid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">lastComment</span> <span class="o">==</span> <span class="nx">request</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">createdAt</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="additional-considerations">Additional Considerations</h2>
<h3 id="email-notifications">Email Notifications</h3>
<p>Consider setting transactional email (via Firebase Cloud Functions or Extensions) to notify yourself, your developers, or admins when a rate-limit threshold has been reached. It is likely something you want to investigate further and potentially disable the offending user&rsquo;s account.</p>
<h3 id="ip-address-rate-limiting">IP Address Rate Limiting</h3>
<p>It is of course possible to enforce IP restrictions on the server. If this is a critical feature, you can bypass the Firebase SDK and implement your own custom <a href="https://firebase.google.com/docs/auth/admin/manage-sessions#advanced_security_enforce_ip_address_restrictions">IP address security</a> logic in a Cloud Function. You will lose the ability to enforce regular Firestore security rules and not be able to perform realtime updates, but you will have full control over the security implementation.</p>


				
			</section>

			<section id="qna" class="my-12 flex flex-col justify-between items-center">
    <h2 class="text-2xl mb-4">Questions? Let's chat</h2>
    <a href="https://discord.gg/SpDdJ3qaKK" class="btn btn-purple btn-lg btn-glow btn-display mx-auto"><span class="w-8 mr-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M524.531,69.836a1.5,1.5,0,0,0-.764-.7A485.065,485.065,0,0,0,404.081,32.03a1.816,1.816,0,0,0-1.923.91,337.461,337.461,0,0,0-14.9,30.6,447.848,447.848,0,0,0-134.426,0,309.541,309.541,0,0,0-15.135-30.6,1.89,1.89,0,0,0-1.924-.91A483.689,483.689,0,0,0,116.085,69.137a1.712,1.712,0,0,0-.788.676C39.068,183.651,18.186,294.69,28.43,404.354a2.016,2.016,0,0,0,.765,1.375A487.666,487.666,0,0,0,176.02,479.918a1.9,1.9,0,0,0,2.063-.676A348.2,348.2,0,0,0,208.12,430.4a1.86,1.86,0,0,0-1.019-2.588,321.173,321.173,0,0,1-45.868-21.853,1.885,1.885,0,0,1-.185-3.126c3.082-2.309,6.166-4.711,9.109-7.137a1.819,1.819,0,0,1,1.9-.256c96.229,43.917,200.41,43.917,295.5,0a1.812,1.812,0,0,1,1.924.233c2.944,2.426,6.027,4.851,9.132,7.16a1.884,1.884,0,0,1-.162,3.126,301.407,301.407,0,0,1-45.89,21.83,1.875,1.875,0,0,0-1,2.611,391.055,391.055,0,0,0,30.014,48.815,1.864,1.864,0,0,0,2.063.7A486.048,486.048,0,0,0,610.7,405.729a1.882,1.882,0,0,0,.765-1.352C623.729,277.594,590.933,167.465,524.531,69.836ZM222.491,337.58c-28.972,0-52.844-26.587-52.844-59.239S193.056,219.1,222.491,219.1c29.665,0,53.306,26.82,52.843,59.239C275.334,310.993,251.924,337.58,222.491,337.58Zm195.38,0c-28.971,0-52.843-26.587-52.843-59.239S388.437,219.1,417.871,219.1c29.667,0,53.307,26.82,52.844,59.239C470.715,310.993,447.538,337.58,417.871,337.58Z"/></svg></span> Open Discord</a>
    <div class="mt-3">
        <discord-count></discord-count>
    </div>
</section>

		</article>
		
		
		<aside class="tableOfContents">
			<nav id="TableOfContents">
  <ul>
    <li><a href="#rate-limit-by-quantity">Rate Limit by Quantity</a>
      <ul>
        <li><a href="#scenario">Scenario</a></li>
        <li><a href="#data-model">Data Model</a></li>
        <li><a href="#security-rules">Security Rules</a></li>
      </ul>
    </li>
    <li><a href="#rate-limit-by-time">Rate Limit By Time</a>
      <ul>
        <li><a href="#scenario-1">Scenario</a></li>
        <li><a href="#data-model-1">Data Model</a></li>
        <li><a href="#security-rules-1">Security Rules</a></li>
      </ul>
    </li>
    <li><a href="#additional-considerations">Additional Considerations</a>
      <ul>
        <li><a href="#email-notifications">Email Notifications</a></li>
        <li><a href="#ip-address-rate-limiting">IP Address Rate Limiting</a></li>
      </ul>
    </li>
  </ul>
</nav>
		</aside>
		
	</div>


</main>

    
<footer class="container text-center my-6 p-8 text-gray3">
    <div class="mx-auto w-24 h-1 my-12 bg-gradient-to-r from-gray5 to-gray4 rounded-full"></div>
    <div class="pt-10">Find an issue with this page? <a class="text-blue-500" href="https://github.com/k0deville/k0deville.github.io">Fix it on GitHub</a></div>

    <div class="py-3">
        Need help? Email <a href="mailto:kodeville97@gmail.com"><strong class="text-white font-bold">kodeville97@gmail.com</strong></a>
    </div>
    <div class="flex justify-center items-center my-2">
        <a href="https://www.youtube.com/c/Kodeville"><i class="w-6 inline-block mx-2"><svg aria-hidden="true" data-prefix="fab" data-icon="youtube" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" class="svgyoutube  "><path fill="currentColor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z" ></path></svg></i></a>
        <a href="https://twitter.com/Kodeville_dev"><i class="w-6 inline-block mx-2"><svg aria-hidden="true" data-prefix="fab" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svgtwitter  "><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z" ></path></svg></i></a>
        <a href="https://github.com/Kodeville-io"><i class="w-6 inline-block mx-2"><svg aria-hidden="true" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="svggithub "><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z" ></path></svg></i></a>
        <a href="https://discord.gg/SpDdJ3qaKK"><i class="w-6 inline-block mx-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M524.531,69.836a1.5,1.5,0,0,0-.764-.7A485.065,485.065,0,0,0,404.081,32.03a1.816,1.816,0,0,0-1.923.91,337.461,337.461,0,0,0-14.9,30.6,447.848,447.848,0,0,0-134.426,0,309.541,309.541,0,0,0-15.135-30.6,1.89,1.89,0,0,0-1.924-.91A483.689,483.689,0,0,0,116.085,69.137a1.712,1.712,0,0,0-.788.676C39.068,183.651,18.186,294.69,28.43,404.354a2.016,2.016,0,0,0,.765,1.375A487.666,487.666,0,0,0,176.02,479.918a1.9,1.9,0,0,0,2.063-.676A348.2,348.2,0,0,0,208.12,430.4a1.86,1.86,0,0,0-1.019-2.588,321.173,321.173,0,0,1-45.868-21.853,1.885,1.885,0,0,1-.185-3.126c3.082-2.309,6.166-4.711,9.109-7.137a1.819,1.819,0,0,1,1.9-.256c96.229,43.917,200.41,43.917,295.5,0a1.812,1.812,0,0,1,1.924.233c2.944,2.426,6.027,4.851,9.132,7.16a1.884,1.884,0,0,1-.162,3.126,301.407,301.407,0,0,1-45.89,21.83,1.875,1.875,0,0,0-1,2.611,391.055,391.055,0,0,0,30.014,48.815,1.864,1.864,0,0,0,2.063.7A486.048,486.048,0,0,0,610.7,405.729a1.882,1.882,0,0,0,.765-1.352C623.729,277.594,590.933,167.465,524.531,69.836ZM222.491,337.58c-28.972,0-52.844-26.587-52.844-59.239S193.056,219.1,222.491,219.1c29.665,0,53.306,26.82,52.843,59.239C275.334,310.993,251.924,337.58,222.491,337.58Zm195.38,0c-28.971,0-52.843-26.587-52.843-59.239S388.437,219.1,417.871,219.1c29.667,0,53.307,26.82,52.844,59.239C470.715,310.993,447.538,337.58,417.871,337.58Z"/></svg></i></a>
    </div>

    <h6>Helpful Links</h6>

    <div class="py-3">
        <a href="../../courses/index.html">Courses</a> | 
        <a href="../index.html">Labs</a> | 
        <a href="../../snippets/index.html">Snippets</a> | 
        <a href="../../tags/index.html">Tags</a> | 
        <a href="../../contributors/index.html">Contrib</a> |
        <a href="../../privacy/index.html">Privacy</a> | 
        <a href="../../terms/index.html">Terms</a>
    </div>

    
    <div class="text-xs">
        Copyright 2023 KodeVille Pvt Ltd<br> 
    </div>

</footer>




    <app-signin></app-signin>
    <algolia-search></algolia-search>
    <hi-mom></hi-mom>

    <email-handler></email-handler>

    <route-loader>
      <div class="fixed w-full top-0 left-0 h-1 gradient-loader"></div>
    </route-loader>

    <toast-message></toast-message>
    <scroll-up></scroll-up>

    </div>

  </body>

<!-- Mirrored from Kodeville.io/lessons/how-to-rate-limit-writes-firestore/ by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 09 Jan 2024 17:06:29 GMT -->
</html>