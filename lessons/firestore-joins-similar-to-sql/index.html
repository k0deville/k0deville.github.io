<!DOCTYPE html>
<html class="dark">
  
<!-- Mirrored from Kodeville.io/lessons/firestore-joins-similar-to-sql/ by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 09 Jan 2024 17:11:56 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Join Collections in Firestore</title>
    <link rel="shortcut icon" href="../../img/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="../../svelte/index.be288b01.css" />
    <script type="module" defer src="../../svelte/index.3d7fd5b5.js" /></script>

    
    <link rel="shortcut icon" href="../../img/favicon.png" type="image/x-icon">
    <link rel="apple-touch-icon" type="image/x-icon" href="../../img/favicon.png" />
    <meta name="theme-color" content="#454e56">
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <link rel="manifest" href="../../manifest.json">
    

 




    <link rel="canonical" href="index.html" />

    <meta name="description" content="Leverage RxJS to perform SQL-like JOIN queries in Firestore">
    <meta name="image" content="https://Kodeville.io/lessons/firestore-joins-similar-to-sql/img/featured.png">

    <meta property="og:title" content="Join Collections in Firestore" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://Kodeville.io/lessons/firestore-joins-similar-to-sql/" />
    <meta property="og:image" content="https://Kodeville.io/lessons/firestore-joins-similar-to-sql/img/featured.png" />
    <meta property="og:description" content="Leverage RxJS to perform SQL-like JOIN queries in Firestore" />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@Kodeville_dev">
    <meta name="twitter:title" content="Join Collections in Firestore">
    <meta name="twitter:description" content="Leverage RxJS to perform SQL-like JOIN queries in Firestore">
    <meta name="twitter:image" content="https://Kodeville.io/lessons/firestore-joins-similar-to-sql/img/featured.png">
    
    <script>
      if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
              navigator.serviceWorker.register('../../sw.js');
          });
      }
    </script>

  </head>
  <body>
    <global-data 
    permalink="https://Kodeville.io/lessons/firestore-joins-similar-to-sql/" 
    vimeo=""
    youtube="QdIKVvguS8U"
    free=""
    next="https://Kodeville.io/lessons/introduction-to-rxfire-rxjs-for-firebase/" 
    prev="https://Kodeville.io/lessons/custom-rxjs-operators-by-example/">
  </global-data>

    
<nav class="flex justify-between container p-6 md:p-8">
  <a
    class="flex justify-center items-center text-center w-12 h-12 logo-gif"
    href="../../index.html"
  >
    <img id="logo" src="../../img/logo.svg" alt="logo" />
    <img class="relative bottom-1 left-1" id="logoBg" src="../../img/fire.gif" alt="fire background" />
  </a>

  <ul class="flex justify-center items-center">
    <if-pro>
      <li slot="basic" class="mx-2 md:mx-4  hover:scale-105 transition-transform">
        <a href="../../pro/index.html" class="font-display text-base font-normal text-green-500 border-green-400 border rounded-md px-2 py-1 hover:drop-shadow-[0_0_9px_rgba(34,197,94,0.9)]">PRO</a>
      </li>
    </if-pro>
    <li class="mx-2 md:mx-4 hover:scale-105 transition-transform">
      <a href="../index.html" class="font-sans text-xl font-bold leading-none text-gray2 hover:text-white">labs</a>
    </li>
    <li class="mx-2 md:mx-4  hover:scale-105 transition-transform">
      <a href="../../courses/index.html" class="font-sans text-xl font-bold leading-none text-gray2 gradient-slide">courses</a>
    </li>
    <li class="ml-2">
      <modal-action type="open" name="search">
        <button class="p-2 mr-2 hidden md:flex justify-between items-center bg-white bg-opacity-10 hover:bg-opacity-20 border border-gray4 hover:border-purple-500 
                 shadow-xl hover:drop-shadow-[0_0_7px_rgba(168,85,247,0.5)] transition-all">
          <span class="text-gray2 w-4 mx-2">
<svg aria-hidden="true" focusable="false" data-prefix="fad" data-icon="search" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-inline--fa fk-search fk-w-16 fk-9x">
<g class="fk-group"><path fill="currentColor" d="M208 80a128 128 0 1 1-90.51 37.49A127.15 127.15 0 0 1 208 80m0-80C93.12 0 0 93.12 0 208s93.12 208 208 208 208-93.12 208-208S322.88 0 208 0z" class="fk-secondary"></path><path fill="currentColor" d="M504.9 476.7L476.6 505a23.9 23.9 0 0 1-33.9 0L343 405.3a24 24 0 0 1-7-17V372l36-36h16.3a24 24 0 0 1 17 7l99.7 99.7a24.11 24.11 0 0 1-.1 34z" class="fk-primary">
</path></g></svg></span>
          <span class="mr-12">Search</span>
          <span class="mx-2 text-xs border border-gray4 rounded-md p-1 px-2">/</span>
        </button>
        <button class="flex md:hidden">
          <span class="text-gray2 w-6 mx-2">
<svg aria-hidden="true" focusable="false" data-prefix="fad" data-icon="search" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-inline--fa fk-search fk-w-16 fk-9x">
<g class="fk-group"><path fill="currentColor" d="M208 80a128 128 0 1 1-90.51 37.49A127.15 127.15 0 0 1 208 80m0-80C93.12 0 0 93.12 0 208s93.12 208 208 208 208-93.12 208-208S322.88 0 208 0z" class="fk-secondary"></path><path fill="currentColor" d="M504.9 476.7L476.6 505a23.9 23.9 0 0 1-33.9 0L343 405.3a24 24 0 0 1-7-17V372l36-36h16.3a24 24 0 0 1 17 7l99.7 99.7a24.11 24.11 0 0 1-.1 34z" class="fk-primary">
</path></g></svg></span>
        </button>
        </modal-action>
      </li>
    <li class="ml-2 mr-6 relative">
      <if-user>
        <a href="../../dashboard/index.html">
          <user-avatar></user-avatar>
        </a>
        <modal-action slot="signed-out" name="signin" type="open">
          <button class="relative hidden md:inline-block px-4 py-2 text-xl font-display text-black hover:text-white bg-white 
                hover:bg-purple-600 drop-shadow-[6px_6px_0_black] hover:drop-shadow-[0_0_7px_rgba(168,85,247,0.5)] transition-all duration-300">
            login
          </button>
          <button class="flex md:hidden">
            <span class="text-gray2 w-6 mx-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M352 96h64c17.7 0 32 14.3 32 32V384c0 17.7-14.3 32-32 32H352c-17.7 0-32 14.3-32 32s14.3 32 32 32h64c53 0 96-43 96-96V128c0-53-43-96-96-96H352c-17.7 0-32 14.3-32 32s14.3 32 32 32zm-7.5 177.4c4.8-4.5 7.5-10.8 7.5-17.4s-2.7-12.9-7.5-17.4l-144-136c-7-6.6-17.2-8.4-26-4.6s-14.5 12.5-14.5 22v72H32c-17.7 0-32 14.3-32 32v64c0 17.7 14.3 32 32 32H160v72c0 9.6 5.7 18.2 14.5 22s19 2 26-4.6l144-136z"/></svg>
</span>
          </button>
        </modal-action>
      </if-user>
    </li>


  </ul>
</nav>


    
<main class="container">


	<div class="flex w-full justify-between">


		<article itemscope itemtype="http://schema.org/Article" class="w-full">
			<meta itemprop="datePublished" content="2018-08-23 17:30:50 -0700 -0700" />
			<meta itemprop="dateModified" content="2018-08-23 17:30:50 -0700 -0700" />
			<meta itemprop="image" content="img/featured.png" />
			<meta itemprop="publisher" content="Kodeville.io" />


			<header>

				
				
				<div itemprop="video" itemscope itemtype="http://schema.org/VideoObject">
					<iframe class="w-full aspect-video" src="https://www.youtube.com/embed/QdIKVvguS8U"
						frameborder="0"
						allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
						allowfullscreen></iframe>

					<meta itemprop="embedUrl" content="https://www.youtube.com/embed/QdIKVvguS8U" />
					<meta itemprop="thumbnailUrl" content="" />
					<meta itemprop="description" content="Leverage RxJS to perform SQL-like JOIN queries in Firestore" />
					<meta itemprop="uploadDate" content="2018-08-23 17:30:50 -0700 -0700" />
					<meta itemprop="publisher" content="Kodeville" />
				</div>
				

				

				<div class="bg-gray6 py-5 px-3 rounded-lg mb-4 flex justify-between mt-3">

					
					
					<a class="flex items-center no-underline" itemprop="author" name="Jeff Delaney" href="../../contributors/jeff-delaney/index.html">
						<img class="w-10 h-10 rounded-full block" src="../../contributors/img/jeff-delaney.webp" alt="Jeff Delaney avatar">
						<span class="flex flex-col ml-2">
							<span class="no-underline">By Jeff Delaney</span>
							<span class="text-xs text-gray4">Posted <time itemprop="dateModified">Aug 23, 2018</time>
						</span>
	
					</a>

					
					<span>
						
							<a href="../../tags/rxjs/index.html"><span class="tag tag-rxjs">#rxjs</span></a>
						
							<a href="../../tags/firebase/index.html"><span class="tag tag-firebase">#firebase</span></a>
						
							<a href="../../tags/firestore/index.html"><span class="tag tag-firestore">#firestore</span></a>
						

						
							<a class="btn btn-transparent ml-4" href="https://github.com/AngularFirebase/133-firestore-joins-custom-rx-operators">
								Source Code
							</a>
						
					</span>
					
				
				</div>

			</header>



			
			<section class="prose dark:prose-invert max-w-full lesson-content" itemprop="articleBody">
				


				<h1 itemprop="name headline" id="join-collections-in-firestore" class="gradient-text">
					Join Collections in Firestore
				</h1>


				<p><strong>How do I perform a SQL JOIN in Firestore?</strong> - it&rsquo;s a difficult question almost all developers will come across. The simple answer for ALL NoSQL databases is that it&rsquo;s just not possible in an apples-to-apples way. We can&rsquo;t perform this operation server-side, however, we can get clever with custom RxJS operators to solve similar problems - plus gain the added benefit of maintaining realtime listeners on all data.</p>
<p>Our operators require <a href="https://github.com/angular/angularfire2">AngularFire</a> and will add some RxJS magic to its existing Observables to tackle the challenge of joining <a href="https://firebase.google.com/docs/firestore/">Firestore</a> documents and collections together easily in Firestore. The code in this lesson is <em>advanced</em> - if you get stuck checkout these related lessons:</p>
<ul>
<li><a href="../firestore-nosql-data-modeling-by-example/index.html">Firestore NoSQL Data Modeling</a></li>
<li><a href="../custom-rxjs-operators-by-example/index.html">Custom RxJS Operators Guide</a></li>
</ul>
<h2 id="document-to-document-join">Document to Document JOIN</h2>
<figure><img src="img/doc-to-doc-join.png"/>
</figure>

<p>Joining documents together is slightly easier than collections. A common data model in NoSQL is to save a field with a document ID that points to a related document. We could just perform separate document reads one-by-one, but that would be cumbersome. Let&rsquo;s build an operator that can handle this process seamlessly as a single Observable.</p>
<p class="tip">This lesson uses strings to keep track of relational data, but you might also use a Firestore `DocumentReference` when dealing with large complex paths.</p>
<h3 id="usage">Usage</h3>
<p>Consider the following data model. We have three unique docs in separate collections. The user doc makes a reference to a specific pet and car ID - this can be a <em>has one</em> or <em>belongs to</em> relationship.</p>
<pre tabindex="0"><code>+users
    docId=jeff {
      car: &#39;subaru&#39;
      pet: &#39;humphrey&#39;
    }

+pets
    docId=humphrey {
        type: &#39;dog&#39;
        food: &#39;kibble&#39;
    }

+cars
    docId=subaru {
        model: &#39;Legacy&#39;
        doors: 4
    }
</code></pre><p>The first argument is the <code>AngularFirestore</code> instance. Operators are pure functions, so they we have to pass dependencies as arguments. The second arg is an object where each <em>key is the field with the related doc ID</em> and the <em>value is the collection containing this doc</em>. The result is a joined object that joins the related document data as a object on each key.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">user$</span> <span class="o">=</span> <span class="nx">afs</span><span class="p">.</span><span class="nb">document</span><span class="p">(</span><span class="s1">&#39;users/jeff&#39;</span><span class="p">).</span><span class="nx">valueChanges</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">joined</span> <span class="o">=</span> <span class="nx">user$</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span> 
</span></span><span class="line"><span class="cl">  <span class="nx">docJoin</span><span class="p">(</span><span class="nx">afs</span><span class="p">,</span> <span class="p">{</span> <span class="nx">car</span><span class="o">:</span> <span class="s1">&#39;cars&#39;</span><span class="p">,</span> <span class="nx">pet</span><span class="o">:</span> <span class="s1">&#39;pets&#39;</span> <span class="p">}</span> <span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">///// result /////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span><span class="nx">userData</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pet</span><span class="o">:</span> <span class="p">{</span> <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;dog&#39;</span><span class="p">,</span> <span class="nx">food</span><span class="o">:</span> <span class="s1">&#39;kibble&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">car</span><span class="o">:</span> <span class="p">{</span> <span class="nx">model</span><span class="o">:</span> <span class="s1">&#39;Legacy&#39;</span><span class="p">,</span> <span class="nx">doors</span>: <span class="kt">4</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="docjoin-code">docJoin Code</h3>
<p>The code for this custom operator can be broken down into three major steps.</p>
<ol>
<li>Retrieve the data from the parent document, save it to an internal variable so it can be combined with the joins.</li>
<li><a href="http://rxjsdocs.com/#/operators/switchMap">switchMap</a> to the doc reads of the relational data and combine them with <a href="http://rxjsdocs.com/#/operators/combineLatest">combineLatest</a>. This will wait for all reads to finish before any data is emitted.</li>
<li>Map the joins to the parent document as a single object Observable.</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">AngularFirestore</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;angularfire2/firestore&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">combineLatest</span><span class="p">,</span> <span class="nx">defer</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;rxjs&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">switchMap</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;rxjs/operators&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">docJoin</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">afs</span>: <span class="kt">AngularFirestore</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span> <span class="p">[</span><span class="nx">key</span>: <span class="kt">string</span><span class="p">]</span><span class="o">:</span> <span class="kt">string</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">source</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">defer</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">let</span> <span class="nx">parent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">paths</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">source</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">switchMap</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// Save the parent data state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="nx">parent</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// Map each path to an Observable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="kr">const</span> <span class="nx">docs$</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">k</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">fullPath</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">paths</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">parent</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">afs</span><span class="p">.</span><span class="nx">doc</span><span class="p">(</span><span class="nx">fullPath</span><span class="p">).</span><span class="nx">valueChanges</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// return combineLatest, it waits for all reads to finish
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">return</span> <span class="nx">combineLatest</span><span class="p">(</span><span class="nx">docs$</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">map</span><span class="p">(</span><span class="nx">arr</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// We now have all the associated douments
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="c1">// Reduce them to a single object based on the parent&#39;s keys
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="kr">const</span> <span class="nx">joins</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">acc</span><span class="p">,</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">idx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span> <span class="p">...</span><span class="nx">acc</span><span class="p">,</span> <span class="p">[</span><span class="nx">cur</span><span class="p">]</span><span class="o">:</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span> <span class="p">{});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// Return the parent doc with the joined objects
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">return</span> <span class="p">{</span> <span class="p">...</span><span class="nx">parent</span><span class="p">,</span> <span class="p">...</span><span class="nx">joins</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><h2 id="collection-join-left-join-sql">Collection Join (Left Join SQL)</h2>
<figure><img src="img/collection-join-firestore.png"/>
</figure>

<p>One of most useful types of joins in a SQL database is a <a href="https://www.w3schools.com/sql/sql_join_left.asp">LEFT JOIN</a>, which gives us all records from the first table, then any matching records from another table based on a shared key.</p>
<p>We can achieve a similar style query in Firestore when documents from two collections share a common key-value pair, similar conceptually to a primary and foreign key in SQL. In this example, it will replace the keys on the left collection with the query data from the right collection.</p>
<h3 id="usage-1">Usage</h3>
<p>Let&rsquo;s say we have a database structure that looks something like this below.</p>
<pre tabindex="0"><code>+users
    docId=jeff {
        userId: &#39;jeff&#39;
        ...data
    }

+orders
    docId=a {
        orderNo: &#39;A&#39;
        userId: &#39;jeff&#39;
    }

    docId=b {
        orderNo: &#39;B&#39;
        userId: &#39;jeff&#39;
    }
</code></pre><p>Our goal is to query the users collection, then query each orders collection for every doc, for instance: <code>orders.where('userId', '==',  userId)</code>.</p>
<p>The operator has three required arguments and an optional limit <code>leftJoin(afs, joinKey, joinCollection, limit=100)</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">users$</span> <span class="o">=</span> <span class="nx">afs</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">valueChanges</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">usersOrders$</span> <span class="o">=</span> <span class="nx">users$</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span> 
</span></span><span class="line"><span class="cl">  <span class="nx">leftJoin</span><span class="p">(</span><span class="nx">afs</span><span class="p">,</span> <span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="s1">&#39;orders&#39;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">///// result: users collection with orders array on each doc ///// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="p">...</span><span class="nx">user1Data</span><span class="p">,</span> <span class="nx">orders</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">orderNo</span><span class="o">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="s1">&#39;jeff&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">orderNo</span><span class="o">:</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="nx">userId</span><span class="o">:</span> <span class="s1">&#39;jeff&#39;</span> <span class="p">}]},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="p">...</span><span class="nx">user2Data</span><span class="p">,</span> <span class="nx">orders</span><span class="o">:</span> <span class="p">[...]}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><h3 id="leftjoin-code">leftJoin Code</h3>
<p>The code for a collection join is slightly more complex, but overall pattern is identical to the previous operator. Let&rsquo;s break them down again:</p>
<ol>
<li>Call <em>switchMap</em> on the initial query.</li>
<li>Loop over documents in that query, setting up a secondary query based on the common key-value pair between the documents. Perform all join queries together with <em>combineLatest</em>.</li>
<li>Map them join queries to documents in the original query.</li>
</ol>
<p class="success">I've also added custom logging to this operator so we know the total documents in the joined query. In the console, it will log something like **Queried 25, Joined 100**, so you know that 125 reads were executed.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">AngularFirestore</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;angularfire2/firestore&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">combineLatest</span><span class="p">,</span> <span class="nx">pipe</span><span class="p">,</span> <span class="k">of</span><span class="p">,</span> <span class="nx">defer</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;rxjs&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">switchMap</span><span class="p">,</span> <span class="nx">tap</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;rxjs/operators&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">leftJoin</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">afs</span>: <span class="kt">AngularFirestore</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">field</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">collection</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">limit</span> <span class="o">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">source</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">defer</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Operator state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kd">let</span> <span class="nx">collectionData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Track total num of joined doc reads
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kd">let</span> <span class="nx">totalJoins</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">source</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">switchMap</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// Clear mapping on each emitted val ;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="c1">// Save the parent data state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="nx">collectionData</span> <span class="o">=</span> <span class="nx">data</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="kr">const</span> <span class="nx">reads$</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">          <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">doc</span> <span class="k">of</span> <span class="nx">collectionData</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Push doc read to Array
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">[</span><span class="nx">field</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="c1">// Perform query on join key, with optional limit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="kr">const</span> <span class="nx">q</span> <span class="o">=</span> <span class="nx">ref</span> <span class="o">=&gt;</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">field</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="nx">doc</span><span class="p">[</span><span class="nx">field</span><span class="p">]).</span><span class="nx">limit</span><span class="p">(</span><span class="nx">limit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="nx">reads$</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">afs</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">q</span><span class="p">).</span><span class="nx">valueChanges</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nx">reads$</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">of</span><span class="p">([]));</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nx">combineLatest</span><span class="p">(</span><span class="nx">reads$</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">map</span><span class="p">(</span><span class="nx">joins</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nx">collectionData</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">v</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">totalJoins</span> <span class="o">+=</span> <span class="nx">joins</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span> <span class="p">...</span><span class="nx">v</span><span class="p">,</span> <span class="p">[</span><span class="nx">collection</span><span class="p">]</span><span class="o">:</span> <span class="nx">joins</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">||</span> <span class="kc">null</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">tap</span><span class="p">(</span><span class="nx">final</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="sb">`Queried </span><span class="si">${</span><span class="p">(</span><span class="nx">final</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">).</span><span class="nx">length</span><span class="si">}</span><span class="sb">, Joined </span><span class="si">${</span><span class="nx">totalJoins</span><span class="si">}</span><span class="sb"> docs`</span>
</span></span><span class="line"><span class="cl">          <span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nx">totalJoins</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><h2 id="the-end">The End</h2>
<p>We built two unique RxJS operators that perform joins in Firestore and solve similar problems to those in SQL databases. Keep in mind, there is no one right way to do this - consider it a starting point to create abstractions around your own business logic.</p>


				
			</section>

			<section id="qna" class="my-12 flex flex-col justify-between items-center">
    <h2 class="text-2xl mb-4">Questions? Let's chat</h2>
    <a href="https://discord.gg/SpDdJ3qaKK" class="btn btn-purple btn-lg btn-glow btn-display mx-auto"><span class="w-8 mr-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M524.531,69.836a1.5,1.5,0,0,0-.764-.7A485.065,485.065,0,0,0,404.081,32.03a1.816,1.816,0,0,0-1.923.91,337.461,337.461,0,0,0-14.9,30.6,447.848,447.848,0,0,0-134.426,0,309.541,309.541,0,0,0-15.135-30.6,1.89,1.89,0,0,0-1.924-.91A483.689,483.689,0,0,0,116.085,69.137a1.712,1.712,0,0,0-.788.676C39.068,183.651,18.186,294.69,28.43,404.354a2.016,2.016,0,0,0,.765,1.375A487.666,487.666,0,0,0,176.02,479.918a1.9,1.9,0,0,0,2.063-.676A348.2,348.2,0,0,0,208.12,430.4a1.86,1.86,0,0,0-1.019-2.588,321.173,321.173,0,0,1-45.868-21.853,1.885,1.885,0,0,1-.185-3.126c3.082-2.309,6.166-4.711,9.109-7.137a1.819,1.819,0,0,1,1.9-.256c96.229,43.917,200.41,43.917,295.5,0a1.812,1.812,0,0,1,1.924.233c2.944,2.426,6.027,4.851,9.132,7.16a1.884,1.884,0,0,1-.162,3.126,301.407,301.407,0,0,1-45.89,21.83,1.875,1.875,0,0,0-1,2.611,391.055,391.055,0,0,0,30.014,48.815,1.864,1.864,0,0,0,2.063.7A486.048,486.048,0,0,0,610.7,405.729a1.882,1.882,0,0,0,.765-1.352C623.729,277.594,590.933,167.465,524.531,69.836ZM222.491,337.58c-28.972,0-52.844-26.587-52.844-59.239S193.056,219.1,222.491,219.1c29.665,0,53.306,26.82,52.843,59.239C275.334,310.993,251.924,337.58,222.491,337.58Zm195.38,0c-28.971,0-52.843-26.587-52.843-59.239S388.437,219.1,417.871,219.1c29.667,0,53.307,26.82,52.844,59.239C470.715,310.993,447.538,337.58,417.871,337.58Z"/></svg></span> Open Discord</a>
    <div class="mt-3">
        <discord-count></discord-count>
    </div>
</section>

		</article>
		
		
		<aside class="tableOfContents">
			<nav id="TableOfContents">
  <ul>
    <li><a href="#document-to-document-join">Document to Document JOIN</a>
      <ul>
        <li><a href="#usage">Usage</a></li>
        <li><a href="#docjoin-code">docJoin Code</a></li>
      </ul>
    </li>
    <li><a href="#collection-join-left-join-sql">Collection Join (Left Join SQL)</a>
      <ul>
        <li><a href="#usage-1">Usage</a></li>
        <li><a href="#leftjoin-code">leftJoin Code</a></li>
      </ul>
    </li>
    <li><a href="#the-end">The End</a></li>
  </ul>
</nav>
		</aside>
		
	</div>


</main>

    
<footer class="container text-center my-6 p-8 text-gray3">
    <div class="mx-auto w-24 h-1 my-12 bg-gradient-to-r from-gray5 to-gray4 rounded-full"></div>
    <div class="pt-10">Find an issue with this page? <a class="text-blue-500" href="https://github.com/k0deville/k0deville.github.io">Fix it on GitHub</a></div>

    <div class="py-3">
        Need help? Email <a href="mailto:kodeville97@gmail.com"><strong class="text-white font-bold">kodeville97@gmail.com</strong></a>
    </div>
    <div class="flex justify-center items-center my-2">
        <a href="https://www.youtube.com/c/Kodeville"><i class="w-6 inline-block mx-2"><svg aria-hidden="true" data-prefix="fab" data-icon="youtube" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" class="svgyoutube  "><path fill="currentColor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z" ></path></svg></i></a>
        <a href="https://twitter.com/Kodeville_dev"><i class="w-6 inline-block mx-2"><svg aria-hidden="true" data-prefix="fab" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svgtwitter  "><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z" ></path></svg></i></a>
        <a href="https://github.com/Kodeville-io"><i class="w-6 inline-block mx-2"><svg aria-hidden="true" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="svggithub "><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z" ></path></svg></i></a>
        <a href="https://discord.gg/SpDdJ3qaKK"><i class="w-6 inline-block mx-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M524.531,69.836a1.5,1.5,0,0,0-.764-.7A485.065,485.065,0,0,0,404.081,32.03a1.816,1.816,0,0,0-1.923.91,337.461,337.461,0,0,0-14.9,30.6,447.848,447.848,0,0,0-134.426,0,309.541,309.541,0,0,0-15.135-30.6,1.89,1.89,0,0,0-1.924-.91A483.689,483.689,0,0,0,116.085,69.137a1.712,1.712,0,0,0-.788.676C39.068,183.651,18.186,294.69,28.43,404.354a2.016,2.016,0,0,0,.765,1.375A487.666,487.666,0,0,0,176.02,479.918a1.9,1.9,0,0,0,2.063-.676A348.2,348.2,0,0,0,208.12,430.4a1.86,1.86,0,0,0-1.019-2.588,321.173,321.173,0,0,1-45.868-21.853,1.885,1.885,0,0,1-.185-3.126c3.082-2.309,6.166-4.711,9.109-7.137a1.819,1.819,0,0,1,1.9-.256c96.229,43.917,200.41,43.917,295.5,0a1.812,1.812,0,0,1,1.924.233c2.944,2.426,6.027,4.851,9.132,7.16a1.884,1.884,0,0,1-.162,3.126,301.407,301.407,0,0,1-45.89,21.83,1.875,1.875,0,0,0-1,2.611,391.055,391.055,0,0,0,30.014,48.815,1.864,1.864,0,0,0,2.063.7A486.048,486.048,0,0,0,610.7,405.729a1.882,1.882,0,0,0,.765-1.352C623.729,277.594,590.933,167.465,524.531,69.836ZM222.491,337.58c-28.972,0-52.844-26.587-52.844-59.239S193.056,219.1,222.491,219.1c29.665,0,53.306,26.82,52.843,59.239C275.334,310.993,251.924,337.58,222.491,337.58Zm195.38,0c-28.971,0-52.843-26.587-52.843-59.239S388.437,219.1,417.871,219.1c29.667,0,53.307,26.82,52.844,59.239C470.715,310.993,447.538,337.58,417.871,337.58Z"/></svg></i></a>
    </div>

    <h6>Helpful Links</h6>

    <div class="py-3">
        <a href="../../courses/index.html">Courses</a> | 
        <a href="../index.html">Labs</a> | 
        <a href="../../snippets/index.html">Snippets</a> | 
        <a href="../../tags/index.html">Tags</a> | 
        <a href="../../contributors/index.html">Contrib</a> |
        <a href="../../privacy/index.html">Privacy</a> | 
        <a href="../../terms/index.html">Terms</a>
    </div>

    
    <div class="text-xs">
        Copyright 2023 KodeVille Pvt Ltd<br> 
    </div>

</footer>




    <app-signin></app-signin>
    <algolia-search></algolia-search>
    <hi-mom></hi-mom>

    <email-handler></email-handler>

    <route-loader>
      <div class="fixed w-full top-0 left-0 h-1 gradient-loader"></div>
    </route-loader>

    <toast-message></toast-message>
    <scroll-up></scroll-up>

    </div>

  </body>

<!-- Mirrored from Kodeville.io/lessons/firestore-joins-similar-to-sql/ by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 09 Jan 2024 17:12:00 GMT -->
</html>